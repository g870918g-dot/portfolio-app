<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>持股比例</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    input { width: 80px; }
    .vix-box { margin-top: 10px; }
    .vix-bar { width: 300px; height: 10px; background: #ddd; position: relative; }
    .vix-fill { height: 100%; width: 0%; background: #4caf50; }
  </style>
</head>
<body>

<h2>持股比例</h2>
<div id="fx">1 USD = -- TWD</div>
<div id="total">總金額：0 TWD</div>
<div id="vixText">VIX（三日）：讀取中...</div>

<table id="stockTable">
  <thead>
    <tr>
      <th>股票代碼</th>
      <th>股數</th>
      <th>股價</th>
      <th>總價 (TWD)</th>
      <th>佔比 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input value="2330"></td>
      <td><input type="number" value="1"></td>
      <td class="price">0</td>
      <td class="value">0</td>
      <td class="ratio">0</td>
    </tr>
  </tbody>
</table>

<button onclick="addRow()">新增</button>
<button onclick="updateAll()">更新</button>

<canvas id="pie" width="400" height="400"></canvas>

<div class="vix-box">
  <div>VIX 近三日平均</div>
  <div class="vix-bar">
    <div id="vixFill" class="vix-fill"></div>
  </div>
  <div id="vixAvg">平均值：--</div>
</div>

<script>
let fxRate = 30;
let pieChart = null;

function addRow() {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input></td>
    <td><input type="number" value="1"></td>
    <td class="price">0</td>
    <td class="value">0</td>
    <td class="ratio">0</td>`;
  document.querySelector('#stockTable tbody').appendChild(tr);
}

async function updateFXRate() {
  try {
    const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=TWD');
    const data = await res.json();
    fxRate = data.rates.TWD;
    document.getElementById('fx').innerText = `1 USD = ${fxRate.toFixed(2)} TWD`;
  } catch {
    document.getElementById('fx').innerText = '1 USD = 30 TWD';
  }
}

async function updateVIX() {
  try {
    const res = await fetch('https://api.stlouisfed.org/fred/series/observations?series_id=VIXCLS&api_key=YOUR_KEY&file_type=json&limit=3');
    const data = res.ok ? (await res.json()).observations : null;
    if (!data) throw 0;
    const values = data.map(d => Number(d.value)).filter(v => !isNaN(v));
    const avg = values.reduce((a,b)=>a+b,0)/values.length;
    document.getElementById('vixText').innerText = `VIX（三日）：${values.join(', ')}`;
    document.getElementById('vixAvg').innerText = `平均值：${avg.toFixed(2)}`;
    const pct = Math.min(avg/40*100,100);
    const fill = document.getElementById('vixFill');
    fill.style.width = pct + '%';
    fill.style.background = avg > 20 ? '#ff5722' : '#4caf50';
  } catch {
    document.getElementById('vixText').innerText = 'VIX（三日）：無法取得';
  }
}

async function updatePrices() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  for (const row of rows) {
    let symbol = row.children[0].querySelector('input').value.trim();
    const qty = Number(row.children[1].querySelector('input').value);
    if (/^\d{4}$/.test(symbol)) symbol += '.TW';
    try {
      const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`);
      const data = await res.json();
      const price = data.quoteResponse.result[0]?.regularMarketPrice || 0;
      row.querySelector('.price').innerText = price.toFixed(2);
      row.querySelector('.value').innerText = (price * qty).toFixed(2);
    } catch {
      row.querySelector('.price').innerText = '0';
      row.querySelector('.value').innerText = '0';
    }
  }
}

function calcTotalAndPie() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  let total = 0;
  rows.forEach(r => total += Number(r.querySelector('.value').innerText));
  document.getElementById('total').innerText = `總金額：${total.toFixed(2)} TWD`;

  const labels = [];
  const data = [];
  rows.forEach(r => {
    const sym = r.children[0].querySelector('input').value;
    const val = Number(r.querySelector('.value').innerText);
    const ratio = total ? val/total*100 : 0;
    r.querySelector('.ratio').innerText = ratio.toFixed(1);
    if (val > 0) {
      labels.push(sym);
      data.push(val);
    }
  });

  if (pieChart) pieChart.destroy();
  pieChart = new Chart(document.getElementById('pie'), {
    type: 'pie',
    data: { labels, datasets: [{ data }] }
  });
}

async function updateAll() {
  await updateFXRate();
  await updatePrices();
  calcTotalAndPie();
  updateVIX();
}

updateFXRate();
updateVIX();
</script>

</body>
</html>
