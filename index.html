<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>持股比例 App</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Portfolio">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:system-ui;margin:0;padding:16px;}
.container{display:flex;gap:20px;flex-wrap:wrap;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #aaa;padding:6px;text-align:center;}
input{width:80px;}
button{margin:4px;}
.left{flex:1 1 60%;}
.right{flex:1 1 35%;max-width:400px;}
canvas#historyChart{margin-top:20px;}
</style>
</head>
<body>

<h2>持股比例 App</h2>

<div class="container">
  <div class="left">
    <table id="holdings">
      <tr>
        <th>股票代碼</th>
        <th>股數</th>
        <th>股價</th>
        <th>總價</th>
        <th>佔比 (%)</th>
        <th>歷史</th>
      </tr>
    </table>
    <button onclick="addRow()">新增持股</button>
    <button onclick="updatePrices()">更新股價</button>
    <select id="currency" onchange="calc()">
      <option value="USD">USD</option>
      <option value="TWD">TWD</option>
    </select> 選擇幣別
  </div>
  <div class="right">
    <canvas id="chart"></canvas>
    <canvas id="historyChart" height="200"></canvas>
  </div>
</div>

<script>
let chart, historyChart;
let usdToTwd = 30;
const FMP_KEY = "YOUR_FMP_KEY"; // <-- 填入你的 FMP API key

function saveHoldings(){
  const table = document.getElementById("holdings");
  const data = [];
  for(let i=1;i<table.rows.length;i++){
    const r=table.rows[i];
    data.push({symbol:r.cells[0].children[0].value.toUpperCase(),shares:Number(r.cells[1].children[0].value)});
  }
  localStorage.setItem("holdings",JSON.stringify(data));
}

function loadHoldings(){
  const data = JSON.parse(localStorage.getItem("holdings")||"[]");
  data.forEach(h=>addRow(h));
  updatePrices();
  setInterval(updatePrices, 120*60*1000); // 自動每兩小時更新
}

function addRow(h=null){
  const table=document.getElementById("holdings");
  const row=table.insertRow();
  row.innerHTML=`
    <td><input placeholder="AAPL / 2330"></td>
    <td><input type="number" value="0"></td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <td><button onclick="showHistory(this)">歷史</button></td>
  `;
  if(h){row.cells[0].children[0].value=h.symbol; row.cells[1].children[0].value=h.shares;}
  saveHoldings();
  updatePrices(); // 新增後立即抓股價
}

async function updateRate(){
  try{
    const res=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=TWD');
    const data=await res.json();
    usdToTwd=data.rates.TWD;
  }catch{}
}

function normalizeSymbol(sym){
  if(/^\d{3,4}$/.test(sym)) return sym+".TW";
  else if(/^[A-Za-z]+$/.test(sym)) return sym;
  return sym;
}

async function updatePrices(){
  await updateRate();
  const rows=document.querySelectorAll("#holdings tr");
  const symbols=[];
  for(let i=1;i<rows.length;i++){
    const s=rows[i].cells[0].children[0].value.trim();
    if(s) symbols.push(normalizeSymbol(s));
  }
  if(symbols.length===0) return;

  const url=`https://financialmodelingprep.com/stable/batch-quote?symbols=${symbols.join(",")}?apikey=${FMP_KEY}`;
  try{
    const res=await fetch(url);
    const data=await res.json();
    for(let i=1;i<rows.length;i++){
      const sym=normalizeSymbol(rows[i].cells[0].children[0].value.trim());
      const stock=data.find(x=>x.symbol===sym);
      rows[i].cells[2].innerText=stock?stock.price.toFixed(2):"0";
    }
  }catch(e){console.log(e);}
  calc();
}

function calc(){
  const currency=document.getElementById("currency").value;
  const rows=document.querySelectorAll("#holdings tr");
  const labels=[],dataArr=[];
  let totalSum=0;

  // 計算總價
  for(let i=1;i<rows.length;i++){
    const shares=Number(rows[i].cells[1].children[0].value);
    let price=Number(rows[i].cells[2].innerText);
    if(currency==="TWD") price*=usdToTwd;
    const total=shares*price;
    rows[i].cells[3].innerText=total.toFixed(2);
    totalSum+=total;
  }

  // 計算佔比，只把股數>0加入圓餅圖
  for(let i=1;i<rows.length;i++){
    const shares=Number(rows[i].cells[1].children[0].value);
    const total=Number(rows[i].cells[3].innerText);
    const pct=totalSum?((total/totalSum)*100):0;
    rows[i].cells[4].innerText=pct.toFixed(2);
    if(shares>0){
      labels.push(rows[i].cells[0].children[0].value.toUpperCase());
      dataArr.push(total);
    }
  }

  // 更新圓餅圖
  const ctx=document.getElementById("chart");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:"pie",data:{labels,datasets:[{data:dataArr}]},options:{responsive:true}});

  saveHoldings();
}

async function showHistory(btn){
  const row=btn.parentElement.parentElement;
  const sym=normalizeSymbol(row.cells[0].children[0].value.trim());
  const histSym=sym.replace(".TW",""); // FMP台股
  const url=`https://financialmodelingprep.com/api/v3/historical-price-full/${histSym}?serietype=line&apikey=${FMP_KEY}`;
  try{
    const res=await fetch(url);
    const data=await res.json();
    if(!data.historical) return alert("抓不到歷史資料");
    const labels=data.historical.slice(0,30).map(d=>d.date).reverse();
    const prices=data.historical.slice(0,30).map(d=>d.close).reverse();
    const ctx=document.getElementById("historyChart");
    if(historyChart) historyChart.destroy();
    historyChart=new Chart(ctx,{
      type:"line",
      data:{labels,datasets:[{label:sym,data:prices,borderColor:'blue',fill:false}]},
      options:{responsive:true}
    });
  }catch(e){console.log(e);}
}

window.onload=loadHoldings;
</script>
</body>
</html>

