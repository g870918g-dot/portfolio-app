<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Ratio</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Portfolio">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: system-ui; padding: 16px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
  input { width: 80px; }
  button { margin: 4px; }
</style>
</head>
<body>
<h2>持股比例 App</h2>

<table id="holdings">
  <tr>
    <th>股票代碼</th>
    <th>股數</th>
    <th>股價 (USD)</th>
    <th>總價</th>
    <th>佔比 (%)</th>
  </tr>
</table>

<br>
<button onclick="addRow()">新增持股</button>
<button onclick="updatePrices()">更新股價</button>
<select id="currency" onchange="calc()">
  <option value="USD">USD</option>
  <option value="TWD">TWD</option>
</select>
<span>選擇幣別</span>

<canvas id="chart" width="300"></canvas>

<script>
let chart;
let usdToTwd = 30; // 初始匯率

// 儲存持股股數和股票代碼（股價不儲存，直接抓）
function saveHoldings() {
  const table = document.getElementById("holdings");
  const data = [];
  for (let i=1;i<table.rows.length;i++){
    const r = table.rows[i];
    data.push({
      symbol: r.cells[0].children[0].value,
      shares: Number(r.cells[1].children[0].value)
    });
  }
  localStorage.setItem("holdings", JSON.stringify(data));
}

function loadHoldings(){
  const data = JSON.parse(localStorage.getItem("holdings")||"[]");
  data.forEach(h => addRow(h));
  updatePrices();
}

// 新增一列股票
function addRow(h=null){
  const table = document.getElementById("holdings");
  const row = table.insertRow();
  row.innerHTML = `
    <td><input placeholder="2330 / AAPL"></td>
    <td><input type="number" value="0"></td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
  `;
  if(h){
    row.cells[0].children[0].value = h.symbol;
    row.cells[1].children[0].value = h.shares;
  }
  saveHoldings();
}

// 抓即時匯率 USD→TWD
async function updateRate(){
  try{
    const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=TWD');
    const data = await res.json();
    usdToTwd = data.rates.TWD;
  }catch(e){
    console.log("匯率抓取失敗，使用預設30", e);
  }
}

// 批次抓股價
async function updatePrices(){
  await updateRate();
  const rows = document.querySelectorAll("#holdings tr");
  const symbols = [];
  for(let i=1;i<rows.length;i++){
    let s = rows[i].cells[0].children[0].value.trim();
    if(s) symbols.push(s);
  }
  if(symbols.length === 0) return;

  // Yahoo Finance 批次抓股價
  const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(",")}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    const results = data.quoteResponse.result;

    for(let i=1;i<rows.length;i++){
      const symbol = rows[i].cells[0].children[0].value.trim();
      if(!symbol) continue;
      // 對應股價
      const stock = results.find(s => s.symbol.toUpperCase() === symbol.toUpperCase() || s.symbol.toUpperCase().includes(symbol.replace(/\./g,"").toUpperCase()));
      if(stock?.regularMarketPrice){
        rows[i].cells[2].innerText = stock.regularMarketPrice.toFixed(2);
      }else{
        rows[i].cells[2].innerText = "-";
      }
    }
  }catch(e){
    console.log("股價抓取失敗", e);
    for(let i=1;i<rows.length;i++){
      rows[i].cells[2].innerText = "-";
    }
  }
  calc();
}

// 計算總價、佔比及畫圖
function calc(){
  const currency = document.getElementById("currency").value;
  const rows = document.querySelectorAll("#holdings tr");
  const labels = [];
  const dataArr = [];
  let totalSum = 0;

  for(let i=1;i<rows.length;i++){
    const shares = Number(rows[i].cells[1].children[0].value);
    let price = Number(rows[i].cells[2].innerText);
    if(isNaN(price)) price = 0;
    if(currency==="TWD") price *= usdToTwd;

    const total = shares * price;
    rows[i].cells[3].innerText = total.toFixed(2);
    totalSum += total;

    labels.push(rows[i].cells[0].children[0].value);
    dataArr.push(total);
  }

  // 計算佔比
  for(let i=1;i<rows.length;i++){
    const pct = totalSum ? (dataArr[i-1]/totalSum*100) : 0;
    rows[i].cells[4].innerText = pct.toFixed(2);
  }

  // 畫圓餅圖
  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"pie",
    data:{
      labels: labels,
      datasets:[{
        data: dataArr,
        backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#C9CBCF","#FF9FBF"]
      }]
    },
    options:{responsive:true}
  });

  saveHoldings();
}

window.onload = loadHoldings;
</script>
</body>
</html>
