<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我的資產配置</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* —— CSS 樣式區 (莫蘭迪風格) —— */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; color: #495057; }

/* 佈局容器 */
.container { display: flex; flex-wrap: wrap; gap: 24px; }
.left { flex: 1 1 100%; }
.right { flex: 1 1 100%; max-width: 100%; margin-top: 20px; display: flex; flex-direction: column; gap: 24px; }

/* 桌面版佈局：左 60%，右 35% */
@media(min-width:768px){ 
    .left { flex:1 1 58%; } 
    .right { flex:1 1 38%; max-width:500px; margin-top:0; } 
}

/* 表格樣式 */
table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 14px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border-radius: 12px; overflow: hidden; }
th, td { border-bottom: 1px solid #f1f3f5; padding: 14px 12px; text-align: center; vertical-align: middle; }
th { background-color: #ffffff; font-weight: 700; color: #868e96; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; border-bottom: 2px solid #f1f3f5; }
tr:last-child td { border-bottom: none; }
tr { transition: all 0.2s ease; position: relative; }
tr:hover { background-color: #f8f9fa; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.05); z-index: 1; }

/* 輸入框優化 */
input { width: 90%; font-size: 14px; text-align: center; border: 1px solid #dee2e6; padding: 8px; border-radius: 6px; background: #fdfdfd; transition: border-color 0.2s; }
input:focus { outline: none; border-color: #74c0fc; background: white; box-shadow: 0 0 0 3px rgba(116, 192, 252, 0.15); }

/* 按鈕樣式 */
button { font-weight: 600; font-size: 13px; cursor: pointer; padding: 10px 18px; border: none; border-radius: 8px; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
button:active { transform: translateY(1px); }
.btn-primary { background-color: #339af0; color: white; }
.btn-primary:hover { background-color: #228be6; box-shadow: 0 4px 10px rgba(51, 154, 240, 0.3); }
.btn-success { background-color: #51cf66; color: white; }
.btn-success:hover { background-color: #40c057; box-shadow: 0 4px 10px rgba(81, 207, 102, 0.3); }
.btn-danger { background-color: #ff6b6b; color: white; padding: 6px 12px; font-size: 12px; }

/* 資訊面板 */
.info-panel {
    background: white; padding: 20px; border-radius: 12px; margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; border: 1px solid #f1f3f5;
}
.info-item { margin-right: 20px; font-size: 15px; font-weight: 600; color: #adb5bd; }
.info-value { color: #343a40; margin-left: 8px; font-size: 20px; font-family: 'Segoe UI', sans-serif; font-weight: 700; }

/* Chart Containers */
.chart-card { 
    background: white; 
    padding: 20px; 
    border-radius: 16px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
    border: 1px solid #f1f3f5;
    position: relative;
    display: flex;
    flex-direction: column;
}
.chart-title {
    font-size: 14px; color: #868e96; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px;
}
.chart-box {
    position: relative;
    height: 250px; /* 固定高度 */
    width: 100%;
}

/* 分類標籤條 */
.row-tw { border-left: 4px solid #ff8787; } 
.row-us { border-left: 4px solid #4dabf7; }

@media (max-width: 480px) {
  .info-panel { flex-direction: column; align-items: flex-start; gap: 12px; }
  table { font-size: 13px; }
  .info-value { font-size: 18px; }
  .container { gap: 16px; }
}
</style>
</head>
<body>

<h2 style="color:#343a40; font-weight:800; margin-bottom: 20px;">我的資產配置</h2>

<div class="info-panel">
    <div class="info-item">
        匯率 <span id="rateDisplay" class="info-value">...</span>
    </div>
    <div class="info-item">
        總資產 <span id="totalDisplay" class="info-value">0</span> <span style="font-size:14px;color:#adb5bd; font-weight:normal;">TWD</span>
    </div>
</div>

<div class="container">
  <div class="left">
    <table id="holdings">
      <thead>
        <tr>
          <th style="width:25%">代碼</th>
          <th style="width:20%">股數</th>
          <th style="width:20%">市價</th>
          <th style="width:25%">總值 (排序)</th>
          <th style="width:10%">%</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap;">
        <button onclick="addRow()" class="btn-primary">+ 新增標的</button>
        <button onclick="updatePrices()" class="btn-success">↻ 更新股價</button>
        </div>
  </div>

  <div class="right">
    
    <div class="chart-card">
        <div class="chart-title">Asset Allocation</div>
        <div class="chart-box" style="height: 280px;">
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-title">Net Worth Growth (Daily)</div>
        <div class="chart-box">
            <canvas id="historyChart"></canvas>
        </div>
        <div style="font-size:11px; color:#ced4da; margin-top:10px; text-align:right;">
            *每日開啟網頁自動記錄
        </div>
    </div>

  </div>
</div>

<script>
// —— 全局變數 ——
let pieChartInstance = null;
let historyChartInstance = null;
let usdToTwd = 30; 
const FINNHUB_KEY = "d5ofc59r01qjast6ddl0d5ofc59r01qjast6ddlg";  
const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMS0yMiAwMjowMzo1MyIsInVzZXJfaWQiOiJnODcwOTE4ZyIsImVtYWlsIjoiZzg3MDkxOGdAZ21haWwuY29tIiwiaXAiOiI2MS4yMzAuMzcuMzEifQ.sunKX_jHdSZAmXUMztvTVOjm9ZCZYNN_xm1fm-Xi7aE"; 

// —— 莫蘭迪配色 ——
const colors = {
    tw: ["#FF8787", "#F06595", "#FF922B", "#CC5DE8", "#FFD43B"], 
    us: ["#4DABF7", "#69DB7C", "#748FFC", "#38D9A9", "#339AF0"], 
    other: "#CED4DA",
    line: "#748FFC", // 曲線圖顏色
    lineFill: "rgba(116, 143, 252, 0.1)" // 曲線圖填充
};

// —— 初始化 ——
window.onload = function() {
    console.log("App Started...");
    try {
        loadHoldings();
        updateExchangeRate();
        // 初始載入歷史圖表 (即使還沒更新股價)
        drawHistoryChart();
    } catch (e) { console.error("Init Error:", e); }
};

// —— 匯率邏輯 ——
async function updateExchangeRate(){
    let rateLoaded = false;
    setTimeout(() => {
        if(!rateLoaded) {
            document.getElementById("rateDisplay").innerText = "30.00 (預設)";
            usdToTwd = 30;
            recalcTotal();
        }
    }, 2000);

    try{
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        const data = await res.json();
        if(data && data.rates && data.rates.TWD){
            usdToTwd = data.rates.TWD;
            document.getElementById("rateDisplay").innerText = `1 USD ≈ ${usdToTwd.toFixed(2)} TWD`;
            rateLoaded = true; 
        }
    } catch(e){
        document.getElementById("rateDisplay").innerText = "連線異常 (預設 30)";
    }
    recalcTotal();
}

// —— 持股管理 ——
function saveHoldings(){
    const rows = document.querySelectorAll("#holdings tbody tr");
    const data = [];
    rows.forEach(r => {
        const inputs = r.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        const shares = inputs[1].value;
        if(sym) data.push({symbol: sym, shares: shares});
    });
    localStorage.setItem("my_portfolio_style", JSON.stringify(data));
}

function loadHoldings(){
    const data = JSON.parse(localStorage.getItem("my_portfolio_style") || "[]");
    const tbody = document.querySelector("#holdings tbody");
    tbody.innerHTML = ""; 
    
    if(data.length === 0) {
        addRow({symbol: "00631L", shares: 1000}); 
        addRow({symbol: "TSM", shares: 10});
    } else {
        data.forEach(h => addRow(h));
    }
    updatePrices(); 
}

function addRow(data = null){
    const tbody = document.querySelector("#holdings tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td style="position:relative;">
            <input type="text" placeholder="代碼" onchange="saveHoldings(); recalcTotal();" value="${data ? data.symbol : ''}" style="font-weight:bold; color:#495057;">
        </td>
        <td><input type="number" placeholder="股數" onchange="saveHoldings(); recalcTotal();" value="${data ? data.shares : 0}"></td>
        <td class="price" style="color:#868e96;">-</td>
        <td class="total" style="font-weight:600; color:#343a40;">0</td>
        <td class="pct" style="color:#868e96; font-size:12px;">0%</td>
    `;
    tr.ondblclick = function() {
        if(confirm("確定移除此股票？")) {
            this.remove();
            saveHoldings();
            recalcTotal();
        }
    };
    tbody.appendChild(tr);
    if(data) saveHoldings();
}

// —— 股價更新 ——
function isTaiwanStock(sym){ return /^\d{4,6}$/.test(sym) || /^00\d{3}[a-zA-Z]?$/.test(sym); }

function getSafeStartDate(){
    let d = new Date(); d.setDate(d.getDate() - 15);
    return d.toISOString().split('T')[0];
}

async function updatePrices(){
    const rows = document.querySelectorAll("#holdings tbody tr");
    const promises = Array.from(rows).map(async (row) => {
        const inputs = row.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        if(!sym) return;

        const priceCell = row.querySelector(".price");
        priceCell.innerText = "..."; 
        
        try {
            if(isTaiwanStock(sym)){
                const startDate = getSafeStartDate();
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${sym}&start_date=${startDate}&token=${FINMIND_TOKEN}`;
                const res = await fetch(url);
                const json = await res.json();
                if(json.data && json.data.length > 0){
                    const p = json.data[json.data.length - 1].close;
                    priceCell.innerText = `${p} TWD`;
                } else { priceCell.innerText = "查無"; }
            } else {
                const url = `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`;
                const res = await fetch(url);
                const json = await res.json();
                if(json.c) priceCell.innerText = `${json.c.toFixed(2)} USD`;
                else priceCell.innerText = "Error";
            }
        } catch(e) { priceCell.innerText = "Err"; }
    });
    await Promise.all(promises);
    recalcTotal();
}

// —— 計算 & 紀錄歷史 ——
function recalcTotal(){
    const tbody = document.querySelector("#holdings tbody");
    const rows = Array.from(document.querySelectorAll("#holdings tbody tr"));
    let totalTwd = 0;
    let rowData = [];

    rows.forEach(row => {
        const inputs = row.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        const shares = parseFloat(inputs[1].value) || 0;
        const isTw = isTaiwanStock(sym);
        
        row.classList.remove("row-tw", "row-us");
        if(sym) { if(isTw) row.classList.add("row-tw"); else row.classList.add("row-us"); }

        const priceText = row.querySelector(".price").innerText;
        let price = 0;
        if(priceText.includes("USD")) price = parseFloat(priceText) * usdToTwd;
        else if(priceText.includes("TWD")) price = parseFloat(priceText);

        const value = Math.floor(shares * price);
        row.querySelector(".total").innerText = value.toLocaleString();
        totalTwd += value;

        if(value >= 0) rowData.push({ element: row, symbol: sym, value: value, isTw: isTw });
    });

    rowData.sort((a, b) => b.value - a.value);
    rowData.forEach(item => tbody.appendChild(item.element));

    rows.forEach(row => {
        const val = parseFloat(row.querySelector(".total").innerText.replace(/,/g, '')) || 0;
        const pct = totalTwd ? ((val / totalTwd) * 100).toFixed(1) : 0;
        row.querySelector(".pct").innerText = `${pct}%`;
    });

    document.getElementById("totalDisplay").innerText = totalTwd.toLocaleString();
    
    // 繪製圓餅圖
    drawPieChart(rowData, totalTwd);
    
    // 【新功能】紀錄今日總資產
    if(totalTwd > 0) saveHistoryRecord(totalTwd);
}

// —— 歷史紀錄邏輯 ——
function saveHistoryRecord(total) {
    // 1. 取得現有歷史
    let history = JSON.parse(localStorage.getItem('my_asset_history') || '[]');
    
    // 2. 取得今日日期字串 YYYY-MM-DD
    const today = new Date().toISOString().split('T')[0];
    
    // 3. 檢查最後一筆是否為今日
    if (history.length > 0) {
        const lastEntry = history[history.length - 1];
        if (lastEntry.date === today) {
            // 如果今天是同一天，更新數值 (取最新的)
            lastEntry.value = total;
        } else {
            // 不同天，新增一筆
            history.push({ date: today, value: total });
        }
    } else {
        // 第一筆
        history.push({ date: today, value: total });
    }
    
    // 4. 限制長度 (例如只存最近 90 天，避免無限變大)
    if (history.length > 90) {
        history = history.slice(history.length - 90);
    }

    // 5. 存檔並繪圖
    localStorage.setItem('my_asset_history', JSON.stringify(history));
    drawHistoryChart();
}

function clearHistory() {
    if(confirm("確定要清除所有歷史走勢紀錄嗎？")) {
        localStorage.removeItem('my_asset_history');
        drawHistoryChart();
    }
}

// —— 繪圖區 ——
function drawPieChart(items, total){
    if(items.length === 0) return;
    const topCount = 8;
    const topItems = items.slice(0, topCount);
    const otherItems = items.slice(topCount);
    
    let labels = [], data = [], chartColors = [];
    topItems.forEach((item, index) => {
        labels.push(`${item.symbol}`);
        data.push(item.value);
        if(item.isTw) chartColors.push(colors.tw[index % colors.tw.length]);
        else chartColors.push(colors.us[index % colors.us.length]);
    });
    if(otherItems.length > 0){
        labels.push("Other");
        data.push(otherItems.reduce((sum, i) => sum + i.value, 0));
        chartColors.push(colors.other);
    }

    const ctx = document.getElementById('pieChart').getContext('2d');
    if(pieChartInstance) pieChartInstance.destroy();

    pieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: chartColors, borderWidth: 0, hoverOffset: 10 }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true, pointStyle: 'circle', font: { size: 11 } } },
                tooltip: { callbacks: { label: function(c) { return ` ${c.label}: ${((c.raw/total)*100).toFixed(1)}%`; } } }
            }
        }
    });
}

function drawHistoryChart() {
    // 讀取歷史
    const history = JSON.parse(localStorage.getItem('my_asset_history') || '[]');
    const ctx = document.getElementById('historyChart').getContext('2d');
    
    if (historyChartInstance) historyChartInstance.destroy();
    
    const labels = history.map(h => h.date.slice(5)); // 只顯示 MM-DD
    const data = history.map(h => h.value);

    // 建立漸層背景
    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(116, 143, 252, 0.4)');
    gradient.addColorStop(1, 'rgba(116, 143, 252, 0.0)');

    historyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '總資產 (TWD)',
                data: data,
                borderColor: colors.line,
                backgroundColor: gradient,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: 'white',
                pointBorderColor: colors.line,
                fill: true,
                tension: 0.4 // 平滑曲線
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    intersect: false,
                    mode: 'index',
                    callbacks: {
                        label: function(context) {
                            return ` ${context.raw.toLocaleString()} TWD`;
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 0 } },
                y: { 
                    grid: { borderDash: [4, 4], color: '#f1f3f5' },
                    ticks: { font: { size: 10 }, callback: function(value) { return (value/10000).toFixed(0) + '萬'; } } 
                }
            }
        }
    });
}
</script>
</body>
</html>
