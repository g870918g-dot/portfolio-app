<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>持股比例 App</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:system-ui;margin:0;padding:16px;}
.container{display:flex;gap:20px;flex-wrap:wrap;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #aaa;padding:6px;text-align:center;}
input{width:80px;}
button,select{margin:4px;}
.left{flex:1 1 60%;}
.right{flex:1 1 35%;max-width:400px;}
#exchangeRate{font-weight:bold;margin-bottom:8px;}
</style>
</head>
<body>

<h2>持股比例 App（總價顯示 TWD）</h2>
<div id="exchangeRate">1 USD = ... TWD</div>

<div class="container">
  <div class="left">
    <table id="holdings">
      <tr>
        <th>股票代碼</th>
        <th>股數</th>
        <th>股價</th>
        <th>總價（TWD）</th>
        <th>佔比 (%)</th>
      </tr>
    </table>

    <button onclick="addRow()">新增持股</button>
    <button onclick="updatePrices()">更新股價</button>
    <br>

    圓餅圖色系：
    <select id="colorScheme" onchange="updateChartColors()">
      <option value="black">黑色系</option>
    </select>

  </div>

  <div class="right">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>

// ————— 全局變數 —————
let chart;
let usdToTwd = 30; 
const FINNHUB_KEY = "d5ofc59r01qjast6ddl0d5ofc59r01qjast6ddlg"; // <-- 放你的 Finnhub Key

// 台股暖色系 / 美股冷色系 / 其他顏色
const warmColors = ["#FF6F61","#FFA07A","#FF8C00","#FFD700","#FFB347","#FF7F50"];
const coolColors = ["#6495ED","#00CED1","#20B2AA","#4682B4","#1E90FF","#00BFFF"];
const othersColor = "#A9A9A9";

// ————— 儲存 / 讀取 localStorage —————
function saveHoldings(){
  const table = document.getElementById("holdings");
  const data = [];
  for(let i=1;i<table.rows.length;i++){
    const r = table.rows[i];
    const sym = r.cells[0].children[0].value.trim().toUpperCase();
    const shares = Number(r.cells[1].children[0].value);
    if(sym && shares >= 0){
      data.push({symbol: sym, shares});
    }
  }
  localStorage.setItem("holdings", JSON.stringify(data));
}

function loadHoldings(){
  const data = JSON.parse(localStorage.getItem("holdings")||"[]");
  data.forEach(h => addRow(h));
  updateExchangeRate();
  updatePrices();
  setInterval(updatePrices, 2*60*60*1000); // 每2小時更新美股價格
  setInterval(updateExchangeRate, 24*60*60*1000); // 每24小時更新匯率
}

// ————— 判斷台股 —————
function isTaiwanStock(symbol){
  return /^\d+$/.test(symbol);
}

// ————— 新增行 —————
function addRow(h=null){
  const table = document.getElementById("holdings");
  const row = table.insertRow();
  row.innerHTML = `
    <td><input placeholder="AAPL / 2330"></td>
    <td><input type="number" value="0"></td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
  `;
  if(h){
    row.cells[0].children[0].value = h.symbol;
    row.cells[1].children[0].value = h.shares;
  }
  saveHoldings();
  updatePricesForRow(row); // 只更新新行，不影響舊行
}

// ————— 更新股價（整表） —————
function updatePrices(){
  const rows = document.querySelectorAll("#holdings tr");
  for(let i=1;i<rows.length;i++){
    updatePricesForRow(rows[i]);
  }
}

// ————— 更新單行股價 —————
async function updatePricesForRow(row){
  const sym = row.cells[0].children[0].value.trim().toUpperCase();
  if(!sym) return;
  try{
    let price = 0;
    if(isTaiwanStock(sym)){
      const res = await fetch(`https://stock-quote-proxy.sukailin1124.workers.dev/quote?symbol=${sym}&market=tse`);
      const data = await res.json();
      price = data.price || 0;
      row.cells[2].innerText = `${price.toFixed(2)} TWD`;
    } else {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`);
      const data = await res.json();
      price = data.c || 0;
      row.cells[2].innerText = `${price.toFixed(2)} USD`;
    }
  }catch(e){
    console.log("抓股價失敗：", e);
    row.cells[2].innerText = "0";
  }
  calc(); // 計算總價與圓餅圖
}

// ————— 更新匯率 —————
async function updateExchangeRate(){
  try{
    const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=TWD");
    const data = await res.json();
    usdToTwd = data.rates.TWD;
    document.getElementById("exchangeRate").innerText = `1 USD = ${usdToTwd.toFixed(4)} TWD`;
    calc();
  }catch(e){console.log("匯率抓取失敗", e);}
}

// ————— 計算總價與圓餅圖（前六大 + Others） —————
function calc(){
  const rows = document.querySelectorAll("#holdings tr");
  let totalTWD = 0;

  // 計算每行總價
  for(let i=1;i<rows.length;i++){
    const shares = Number(rows[i].cells[1].children[0].value);
    let rawPrice = 0;
    const priceText = rows[i].cells[2].innerText;
    if(priceText.includes("USD")){
      rawPrice = Number(priceText.replace(" USD","")) * usdToTwd;
    } else {
      rawPrice = Number(priceText.replace(" TWD",""));
    }
    const total = shares * rawPrice;
    rows[i].cells[3].innerText = total.toFixed(2);
    totalTWD += total;
  }

  // 計算佔比 & 圓餅圖
  let stockTotals = [];
  for(let i=1;i<rows.length;i++){
    const shares = Number(rows[i].cells[1].children[0].value);
    if(shares <= 0) continue;
    const total = Number(rows[i].cells[3].innerText);
    const sym = rows[i].cells[0].children[0].value.toUpperCase();
    stockTotals.push({symbol: sym, total, isTW: isTaiwanStock(sym)});
    rows[i].cells[4].innerText = totalTWD ? (total/totalTWD*100).toFixed(2) : 0;
  }

  // 前6大 + Others
  stockTotals.sort((a,b)=>b.total - a.total);
  const top6 = stockTotals.slice(0,6);
  const others = stockTotals.slice(6);

  const chartDataLabels = [];
  const chartDataValues = [];
  const chartDataColors = [];

  top6.forEach((s,i)=>{
    chartDataLabels.push(s.symbol);
    chartDataValues.push(s.total);
    chartDataColors.push(s.isTW ? warmColors[i % warmColors.length] : coolColors[i % coolColors.length]);
  });

  if(others.length > 0){
    chartDataLabels.push("Others");
    chartDataValues.push(others.reduce((sum,s)=>sum+s.total,0));
    chartDataColors.push(othersColor);
  }

  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"pie",
    data:{
      labels: chartDataLabels,
      datasets:[{data: chartDataValues, backgroundColor: chartDataColors}]
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{
            label: function(context){
              const label = context.label || '';
              const value = context.parsed;
              const total = chartDataValues.reduce((a,b)=>a+b,0);
              const pct = total ? (value/total*100).toFixed(2) : 0;
              return `${label}: ${pct}%`;
            }
          }
        }
      }
    }
  });

  saveHoldings();
}

// ————— 色系切換 —————
function updateChartColors(){
  const scheme = document.getElementById("colorScheme").value;
  if(chart){
    chart.data.datasets[0].backgroundColor = colorSchemes[scheme];
    chart.update();
  }
}

window.onload = loadHoldings;

</script>
</body>
</html>
