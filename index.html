<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆ‘çš„è³‡ç”¢é…ç½® (ç¾æ„Ÿå‡ç´šç‰ˆ)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* â€”â€” CSS æ¨£å¼å€ â€”â€” */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; color: #495057; }

/* ä½ˆå±€å®¹å™¨ */
.container { display: flex; flex-wrap: wrap; gap: 24px; }
.left { flex: 1 1 100%; }
.right { flex: 1 1 100%; max-width: 100%; margin-top: 20px; }

/* æ¡Œé¢ç‰ˆä½ˆå±€ï¼šå·¦ 60%ï¼Œå³ 35% */
@media(min-width:768px){ 
    .left { flex:1 1 60%; } 
    .right { flex:1 1 35%; max-width:400px; margin-top:0; } 
}

/* è¡¨æ ¼æ¨£å¼ (ç¾åŒ–ç‰ˆ) */
table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 14px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border-radius: 12px; overflow: hidden; }
th, td { border-bottom: 1px solid #f1f3f5; padding: 14px 12px; text-align: center; vertical-align: middle; }
th { background-color: #ffffff; font-weight: 700; color: #868e96; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; border-bottom: 2px solid #f1f3f5; }
tr:last-child td { border-bottom: none; }
tr { transition: all 0.2s ease; position: relative; }
tr:hover { background-color: #f8f9fa; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.05); z-index: 1; }

/* è¼¸å…¥æ¡†å„ªåŒ– */
input { width: 90%; font-size: 14px; text-align: center; border: 1px solid #dee2e6; padding: 8px; border-radius: 6px; background: #fdfdfd; transition: border-color 0.2s; }
input:focus { outline: none; border-color: #74c0fc; background: white; box-shadow: 0 0 0 3px rgba(116, 192, 252, 0.15); }

/* æŒ‰éˆ•æ¨£å¼ */
button { font-weight: 600; font-size: 13px; cursor: pointer; padding: 10px 18px; border: none; border-radius: 8px; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
button:active { transform: translateY(1px); }
.btn-primary { background-color: #339af0; color: white; }
.btn-primary:hover { background-color: #228be6; box-shadow: 0 4px 10px rgba(51, 154, 240, 0.3); }
.btn-success { background-color: #51cf66; color: white; }
.btn-success:hover { background-color: #40c057; box-shadow: 0 4px 10px rgba(81, 207, 102, 0.3); }

/* è³‡è¨Šé¢æ¿ */
.info-panel {
    background: white; padding: 20px; border-radius: 12px; margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; border: 1px solid #f1f3f5;
}
.info-item { margin-right: 20px; font-size: 15px; font-weight: 600; color: #adb5bd; }
.info-value { color: #343a40; margin-left: 8px; font-size: 20px; font-family: 'Segoe UI', sans-serif; font-weight: 700; }

/* Chart Container */
.chart-container { 
    background: white; 
    padding: 24px; 
    border-radius: 16px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
    min-height: 320px;
    border: 1px solid #f1f3f5;
    position: relative;
}

/* åˆ†é¡æ¨™ç±¤æ¢ (Row Indicators) */
.row-tw { border-left: 4px solid #ff8787; } /* å°è‚¡ç´…æ¢ */
.row-us { border-left: 4px solid #4dabf7; } /* ç¾è‚¡è—æ¢ */

/* æ¨™ç±¤ Badge */
.tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 4px; font-weight: bold; vertical-align: middle; }
.tag-tw { background-color: #ff8787; }
.tag-us { background-color: #4dabf7; }

@media (max-width: 480px) {
  .info-panel { flex-direction: column; align-items: flex-start; gap: 12px; }
  table { font-size: 13px; }
  .info-value { font-size: 18px; }
  .container { gap: 16px; }
}
</style>
</head>
<body>

<h2 style="color:#343a40; font-weight:800; margin-bottom: 20px;">æˆ‘çš„è³‡ç”¢é…ç½®</h2>

<div class="info-panel">
    <div class="info-item">
        åŒ¯ç‡ <span id="rateDisplay" class="info-value">...</span>
    </div>
    <div class="info-item">
        ç¸½è³‡ç”¢ <span id="totalDisplay" class="info-value">0</span> <span style="font-size:14px;color:#adb5bd; font-weight:normal;">TWD</span>
    </div>
</div>

<div class="container">
  <div class="left">
    <table id="holdings">
      <thead>
        <tr>
          <th style="width:25%">ä»£ç¢¼</th>
          <th style="width:20%">è‚¡æ•¸</th>
          <th style="width:20%">å¸‚åƒ¹</th>
          <th style="width:25%">ç¸½å€¼ (æ’åº)</th>
          <th style="width:10%">%</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:20px; display:flex; gap:12px;">
        <button onclick="addRow()" class="btn-primary">+ æ–°å¢æ¨™çš„</button>
        <button onclick="updatePrices()" class="btn-success">â†» æ›´æ–°è‚¡åƒ¹</button>
    </div>
  </div>

  <div class="right">
    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<script>
// â€”â€” å…¨å±€è®Šæ•¸ â€”â€”
let chartInstance = null;
let usdToTwd = 30; // é è¨­åŒ¯ç‡
const FINNHUB_KEY = "d5ofc59r01qjast6ddl0d5ofc59r01qjast6ddlg";  
const FINMIND_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMS0yMiAwMjowMzo1MyIsInVzZXJfaWQiOiJnODcwOTE4ZyIsImVtYWlsIjoiZzg3MDkxOGdAZ21haWwuY29tIiwiaXAiOiI2MS4yMzAuMzcuMzEifQ.sunKX_jHdSZAmXUMztvTVOjm9ZCZYNN_xm1fm-Xi7aE"; 

// â€”â€” ğŸ¨ æ–°ç‰ˆè«è˜­è¿ªé…è‰² â€”â€”
const colors = {
    // å°è‚¡ (æš–è‰²ç³»)ï¼šæŸ”å’Œç´…ã€çŠç‘šç²‰ã€æš–æ©˜ã€ç´«ä¸é¦™ã€éµé»ƒ
    tw: ["#FF8787", "#F06595", "#FF922B", "#CC5DE8", "#FFD43B"], 
    // ç¾è‚¡ (å†·è‰²ç³»)ï¼šå¤©ç©ºè—ã€é’ç“·ç¶ ã€é›é’ã€æ¹–æ°´ç¶ ã€æ·±è—
    us: ["#4DABF7", "#69DB7C", "#748FFC", "#38D9A9", "#339AF0"], 
    // å…¶ä»–
    other: "#CED4DA"
};

// â€”â€” åˆå§‹åŒ– â€”â€”
window.onload = function() {
    console.log("App Started...");
    try {
        loadHoldings();       // 1. å»ºç«‹è¡¨æ ¼
        updateExchangeRate(); // 2. æŠ“åŒ¯ç‡
    } catch (e) {
        console.error("Init Error:", e);
    }
};

// â€”â€” åŒ¯ç‡é‚è¼¯ â€”â€”
async function updateExchangeRate(){
    let rateLoaded = false;
    setTimeout(() => {
        if(!rateLoaded) {
            document.getElementById("rateDisplay").innerText = "30.00 (é è¨­)";
            usdToTwd = 30;
            recalcTotal();
        }
    }, 2000);

    try{
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        const data = await res.json();
        if(data && data.rates && data.rates.TWD){
            usdToTwd = data.rates.TWD;
            document.getElementById("rateDisplay").innerText = `1 USD â‰ˆ ${usdToTwd.toFixed(2)} TWD`;
            rateLoaded = true; 
        }
    } catch(e){
        document.getElementById("rateDisplay").innerText = "é€£ç·šç•°å¸¸ (é è¨­ 30)";
    }
    recalcTotal();
}

// â€”â€” æŒè‚¡ç®¡ç† â€”â€”
function saveHoldings(){
    const rows = document.querySelectorAll("#holdings tbody tr");
    const data = [];
    rows.forEach(r => {
        const inputs = r.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        const shares = inputs[1].value;
        if(sym) data.push({symbol: sym, shares: shares});
    });
    localStorage.setItem("my_portfolio_style", JSON.stringify(data));
}

function loadHoldings(){
    const data = JSON.parse(localStorage.getItem("my_portfolio_style") || "[]");
    const tbody = document.querySelector("#holdings tbody");
    tbody.innerHTML = ""; 
    
    if(data.length === 0) {
        addRow({symbol: "00631L", shares: 1000}); 
        addRow({symbol: "TSM", shares: 10});
    } else {
        data.forEach(h => addRow(h));
    }
    updatePrices(); 
}

function addRow(data = null){
    const tbody = document.querySelector("#holdings tbody");
    const tr = document.createElement("tr");
    
    // é è¨­æ¨£å¼ï¼Œç¨å¾Œåœ¨ recalcTotal æœƒæ ¹æ“šä»£ç¢¼è‡ªå‹•åŠ ä¸Šé¡è‰²æ¢
    tr.innerHTML = `
        <td style="position:relative;">
            <input type="text" placeholder="ä»£ç¢¼" onchange="saveHoldings(); recalcTotal();" value="${data ? data.symbol : ''}" style="font-weight:bold; color:#495057;">
        </td>
        <td><input type="number" placeholder="è‚¡æ•¸" onchange="saveHoldings(); recalcTotal();" value="${data ? data.shares : 0}"></td>
        <td class="price" style="color:#868e96;">-</td>
        <td class="total" style="font-weight:600; color:#343a40;">0</td>
        <td class="pct" style="color:#868e96; font-size:12px;">0%</td>
    `;
    
    tr.ondblclick = function() {
        if(confirm("ç¢ºå®šç§»é™¤æ­¤è‚¡ç¥¨ï¼Ÿ")) {
            this.remove();
            saveHoldings();
            recalcTotal();
        }
    };
    
    tbody.appendChild(tr);
    // ä¸ç«‹å³å­˜æª”ï¼Œé¿å…ç©ºè¡Œå½±éŸ¿
    if(data) saveHoldings();
}

// â€”â€” è‚¡åƒ¹æ›´æ–° â€”â€”
function isTaiwanStock(sym){
    return /^\d{4,6}$/.test(sym) || /^00\d{3}[a-zA-Z]?$/.test(sym);
}

function getSafeStartDate(){
    let d = new Date();
    d.setDate(d.getDate() - 15);
    return d.toISOString().split('T')[0];
}

async function updatePrices(){
    const rows = document.querySelectorAll("#holdings tbody tr");
    const promises = Array.from(rows).map(async (row) => {
        const inputs = row.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        if(!sym) return;

        const priceCell = row.querySelector(".price");
        priceCell.innerText = "..."; 
        
        try {
            if(isTaiwanStock(sym)){
                const startDate = getSafeStartDate();
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${sym}&start_date=${startDate}&token=${FINMIND_TOKEN}`;
                const res = await fetch(url);
                const json = await res.json();
                
                if(json.data && json.data.length > 0){
                    const lastData = json.data[json.data.length - 1]; 
                    const p = lastData.close;
                    priceCell.innerText = `${p} TWD`;
                } else {
                    priceCell.innerText = "æŸ¥ç„¡";
                }
            } else {
                const url = `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`;
                const res = await fetch(url);
                const json = await res.json();
                if(json.c) priceCell.innerText = `${json.c.toFixed(2)} USD`;
                else priceCell.innerText = "Error";
            }
        } catch(e) {
            priceCell.innerText = "Err";
        }
    });

    await Promise.all(promises);
    recalcTotal();
}

// â€”â€” è¨ˆç®— & åˆ†é¡é¡¯ç¤º â€”â€”
function recalcTotal(){
    const tbody = document.querySelector("#holdings tbody");
    const rows = Array.from(document.querySelectorAll("#holdings tbody tr"));
    let totalTwd = 0;
    let rowData = [];

    // 1. è¨ˆç®—æ•¸å€¼
    rows.forEach(row => {
        const inputs = row.getElementsByTagName("input");
        const sym = inputs[0].value.trim().toUpperCase();
        const shares = parseFloat(inputs[1].value) || 0;
        
        // åˆ¤æ–·å°ç¾è‚¡ï¼Œä¸¦åŠ ä¸Šè¦–è¦ºæ¨™ç±¤
        const isTw = isTaiwanStock(sym);
        
        // ç§»é™¤èˆŠçš„ classï¼Œé‡æ–°åˆ†é¡
        row.classList.remove("row-tw", "row-us");
        if(sym) {
            if(isTw) row.classList.add("row-tw");
            else row.classList.add("row-us");
        }

        const priceText = row.querySelector(".price").innerText;
        let price = 0;

        if(priceText.includes("USD")) price = parseFloat(priceText) * usdToTwd;
        else if(priceText.includes("TWD")) price = parseFloat(priceText);

        const value = Math.floor(shares * price);
        row.querySelector(".total").innerText = value.toLocaleString();
        totalTwd += value;

        if(value >= 0) {
            rowData.push({
                element: row,
                symbol: sym,
                value: value,
                isTw: isTw
            });
        }
    });

    // 2. æ’åº
    rowData.sort((a, b) => b.value - a.value);

    // 3. é‡æ’ DOM
    rowData.forEach(item => {
        tbody.appendChild(item.element);
    });

    // 4. æ›´æ–° %
    rows.forEach(row => {
        const valStr = row.querySelector(".total").innerText.replace(/,/g, '');
        const val = parseFloat(valStr) || 0;
        const pct = totalTwd ? ((val / totalTwd) * 100).toFixed(1) : 0;
        row.querySelector(".pct").innerText = `${pct}%`;
    });

    document.getElementById("totalDisplay").innerText = totalTwd.toLocaleString();
    
    // 5. ç¹ªåœ–
    drawChart(rowData, totalTwd);
}

function drawChart(items, total){
    if(items.length === 0) return;
    
    // Top 8 + Other
    const topCount = 8;
    const topItems = items.slice(0, topCount);
    const otherItems = items.slice(topCount);
    
    let labels = [], data = [], chartColors = [];

    topItems.forEach((item, index) => {
        // åœ¨ Chart çš„æ¨™ç±¤ä¸Šä¹ŸåŠ ä¸Šåˆ†é¡æ¨™è¨˜ (TW/US)
        const typeLabel = item.isTw ? "(TW)" : "(US)";
        labels.push(`${item.symbol}`);
        data.push(item.value);
        
        if(item.isTw) chartColors.push(colors.tw[index % colors.tw.length]);
        else chartColors.push(colors.us[index % colors.us.length]);
    });

    if(otherItems.length > 0){
        labels.push("Other");
        data.push(otherItems.reduce((sum, i) => sum + i.value, 0));
        chartColors.push(colors.other);
    }

    const ctx = document.getElementById('chart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: chartColors, borderWidth: 0, hoverOffset: 10 }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { 
                        boxWidth: 10, 
                        usePointStyle: true, 
                        pointStyle: 'circle',
                        padding: 15,
                        font: { family: "'Segoe UI', sans-serif", size: 12 }
                    } 
                },
                tooltip: {
                    backgroundColor: 'rgba(52, 58, 64, 0.9)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            let val = context.raw;
                            let pct = ((val / total) * 100).toFixed(1);
                            return ` ${context.label}: ${pct}% ($${val.toLocaleString()})`;
                        }
                    }
                }
            }
        }
    });
}
</script>
</body>
</html>
