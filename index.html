<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>持股比例 App</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Portfolio">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:system-ui;margin:0;padding:16px;}
.container{display:flex;gap:20px;flex-wrap:wrap;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #aaa;padding:6px;text-align:center;}
input{width:80px;}
button,select{margin:4px;}
.left{flex:1 1 60%;}
.right{flex:1 1 35%;max-width:400px;}
#exchangeRate{font-weight:bold;margin-bottom:8px;}
</style>
</head>
<body>
<h2>持股比例 App (USD→TWD)</h2>
<div id="exchangeRate">1 USD = ... TWD</div>
<div class="container">
  <div class="left">
    <table id="holdings">
      <tr>
        <th>股票代碼</th>
        <th>股數</th>
        <th>股價 (USD)</th>
        <th>總價 (USD)</th>
        <th>佔比 (%)</th>
      </tr>
    </table>
    <button onclick="addRow()">新增持股</button>
    <button onclick="updatePrices()">更新股價</button>
    <br>
    圓餅圖色系：
    <select id="colorScheme" onchange="updateChartColors()">
      <option value="bright">亮色系</option>
      <option value="pastel">柔和粉彩</option>
      <option value="dark">深色系</option>
      <option value="ocean">藍綠海洋系</option>
    </select>
  </div>
  <div class="right">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
let chart;
const FINNHUB_KEY = "d5ofc59r01qjast6ddl0d5ofc59r01qjast6ddlg"; // <-- 填入你的 Finnhub API key
const TWD_API = "https://api.exchangerate.host/latest?base=USD&symbols=TWD";

const colorSchemes = {
  bright:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"],
  pastel:["#FFB3BA","#BAE1FF","#BAFFC9","#FFFFBA","#FFDFBA","#E0BAFF"],
  dark:["#D32F2F","#1976D2","#388E3C","#FBC02D","#7B1FA2","#F57C00"],
  ocean:["#00A8E8","#007EA7","#00B4D8","#48CAE4","#90E0EF","#CAF0F8"]
};

let usdToTwd = 30; // 預設匯率

function saveHoldings(){
  const table = document.getElementById("holdings");
  const data = [];
  for(let i=1;i<table.rows.length;i++){
    const r=table.rows[i];
    data.push({symbol:r.cells[0].children[0].value.toUpperCase(),shares:Number(r.cells[1].children[0].value)});
  }
  localStorage.setItem("holdings",JSON.stringify(data));
}

function loadHoldings(){
  const data = JSON.parse(localStorage.getItem("holdings")||"[]");
  data.forEach(h=>addRow(h));
  updateExchangeRate();
  updatePrices();
  setInterval(updatePrices, 2*60*60*1000); // 美股每兩小時更新
  setInterval(updateExchangeRate, 24*60*60*1000); // 匯率每天更新
}

function addRow(h=null){
  const table=document.getElementById("holdings");
  const row=table.insertRow();
  row.innerHTML=`
    <td><input placeholder="AAPL / 2330"></td>
    <td><input type="number" value="0"></td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
  `;
  if(h){row.cells[0].children[0].value=h.symbol; row.cells[1].children[0].value=h.shares;}
  saveHoldings();
  updatePrices();
}

async function updateExchangeRate(){
  try{
    const res = await fetch(TWD_API);
    const data = await res.json();
    usdToTwd = data.rates.TWD;
    document.getElementById("exchangeRate").innerText = `1 USD = ${usdToTwd.toFixed(2)} TWD`;
    calc();
  }catch(e){console.log("匯率抓取錯誤",e);}
}

// 判斷是台股還是美股
function isTaiwanStock(symbol){ return /^\d+$/.test(symbol); }

async function updatePrices(){
  const rows=document.querySelectorAll("#holdings tr");
  for(let i=1;i<rows.length;i++){
    const sym = rows[i].cells[0].children[0].value.trim().toUpperCase();
    if(!sym) continue;
    try{
      let price=0;
      if(isTaiwanStock(sym)){
        // 台股抓前一天收盤價
        const res = await fetch(`https://stock-quote-proxy.sukailin1124.workers.dev/quote?symbol=${sym}&market=tse`);
        const data = await res.json();
        price = data.price || 0;
      } else {
        // 美股 Finnhub
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`);
        const data = await res.json();
        price = data.c || 0;
      }
      rows[i].cells[2].innerText = price.toFixed(2);
    }catch(e){console.log("抓股價錯誤:",e); rows[i].cells[2].innerText="0";}
  }
  calc();
}

function calc(){
  const rows=document.querySelectorAll("#holdings tr");
  const labels=[],dataArr=[];
  let totalSum=0;
  for(let i=1;i<rows.length;i++){
    const shares = Number(rows[i].cells[1].children[0].value);
    let price = Number(rows[i].cells[2].innerText);
    // 統一換算成 USD
    if(isTaiwanStock(rows[i].cells[0].children[0].value.trim())){
      price = price / usdToTwd;
      rows[i].cells[2].innerText = price.toFixed(2);
    }
    const total = shares * price;
    rows[i].cells[3].innerText = total.toFixed(2);
    totalSum += total;
  }
  for(let i=1;i<rows.length;i++){
    const total = Number(rows[i].cells[3].innerText);
    const pct = totalSum ? (total/totalSum*100) : 0;
    rows[i].cells[4].innerText = pct.toFixed(2);
    if(Number(rows[i].cells[1].children[0].value) > 0){
      labels.push(rows[i].cells[0].children[0].value.toUpperCase());
      dataArr.push(total);
    }
  }
  const ctx=document.getElementById("chart");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"pie",
    data:{labels,datasets:[{data:dataArr,backgroundColor:colorSchemes["bright"]}]},
    options:{responsive:true}
  });
}

function updateChartColors(){
  const scheme = document.getElementById("colorScheme").value;
  if(chart) chart.data.datasets[0].backgroundColor = colorSchemes[scheme];
  if(chart) chart.update();
}

window.onload = loadHoldings;
</script>
</body>
</html>
