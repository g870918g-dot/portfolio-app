<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>持股比例 App</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:"Microsoft JhengHei",sans-serif;
  margin:0;
  padding:16px;
}

.container{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

.left{flex:1 1 60%;}
.right{flex:1 1 35%;max-width:420px;}

table{
  border-collapse:collapse;
  width:100%;
}

th,td{
  border:1px solid #aaa;
  padding:6px;
  text-align:center;
  white-space:nowrap;
}

input{width:80px;}

button{
  margin:6px 4px;
}

#exchangeRate{
  font-weight:bold;
  margin-bottom:10px;
}

/* 手機橫向捲動，避免爆版 */
@media (max-width:768px){
  .container{flex-direction:column;}
  table{display:block;overflow-x:auto;}
}
</style>
</head>

<body>

<h2>持股比例 App</h2>

<div id="exchangeRate">
  1 USD = -- TWD
  <span id="totalAmount" style="margin-left:16px;">總金額：0 TWD</span>
</div>

<div class="container">
  <div class="left">

    <table id="holdings">
      <tr>
        <th>股票代碼</th>
        <th>股數</th>
        <th>股價</th>
        <th>總價 (TWD)</th>
        <th>佔比 %</th>
      </tr>
    </table>

    <button onclick="addRow()">新增持股</button>
    <button onclick="updatePrices()">更新股價</button>
  </div>

  <div class="right">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
/* ===== API KEY ===== */
const FINNHUB_KEY="d5ofc59r01qjast6ddl0d5ofc59r01qjast6ddlg";
const FINMIND_TOKEN="你的完整 FinMind Token";

let usdToTwd=30;
let chart;

/* ===== 判斷台股 ===== */
function isTaiwanStock(sym){
  return /^\d+$/.test(sym) || /^00\d{3}[LR]?$/.test(sym);
}

function getPrevTradeDate(){
  const d=new Date();
  do{d.setDate(d.getDate()-1);}while(d.getDay()==0||d.getDay()==6);
  return d.toISOString().slice(0,10);
}

/* ===== localStorage ===== */
function saveHoldings(){
  const rows=[...document.querySelectorAll("#holdings tr")].slice(1);
  const data=rows.map(r=>({
    symbol:r.cells[0].children[0].value,
    shares:r.cells[1].children[0].value
  })).filter(d=>d.symbol);
  localStorage.setItem("holdings",JSON.stringify(data));
}

function loadHoldings(){
  const data=JSON.parse(localStorage.getItem("holdings")||"[]");
  if(data.length===0) addRow();
  else data.forEach(addRow);
  updateExchangeRate();
  updatePrices();
}

/* ===== UI ===== */
function addRow(h=null){
  const row=document.getElementById("holdings").insertRow();
  row.innerHTML=`
    <td><input></td>
    <td><input type="number" value="0"></td>
    <td>0</td>
    <td>0</td>
    <td>0</td>`;
  if(h){
    row.cells[0].children[0].value=h.symbol;
    row.cells[1].children[0].value=h.shares;
  }
}

/* ===== 匯率 ===== */
async function updateExchangeRate(){
  try{
    const res=await fetch("https://open.er-api.com/v6/latest/USD");
    const data=await res.json();
    usdToTwd=data.rates.TWD;
    document.getElementById("exchangeRate").innerHTML=
      `1 USD = ${usdToTwd.toFixed(4)} TWD
       <span id="totalAmount" style="margin-left:16px;">總金額：0 TWD</span>`;
  }catch{
    usdToTwd=30;
  }
}

/* ===== 股價 ===== */
async function updatePrices(){
  const rows=[...document.querySelectorAll("#holdings tr")].slice(1);
  await Promise.all(rows.map(updateRowPrice));
  calc();
}

async function updateRowPrice(row){
  const sym=row.cells[0].children[0].value.toUpperCase();
  if(!sym) return;

  let price=0;
  if(isTaiwanStock(sym)){
    const d=getPrevTradeDate();
    const r=await fetch(
      `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${sym}&start_date=${d}&end_date=${d}&token=${FINMIND_TOKEN}`);
    const j=await r.json();
    price=j.data?.[0]?.close||0;
    row.cells[2].innerText=price.toFixed(2)+" TWD";
  }else{
    const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`);
    const j=await r.json();
    price=j.c||0;
    row.cells[2].innerText=price.toFixed(2)+" USD";
  }
}

/* ===== 計算 + 圖表 ===== */
function calc(){
  const rows=[...document.querySelectorAll("#holdings tr")].slice(1);
  let totalTWD=0;
  let stocks=[];

  rows.forEach(r=>{
    const sym=r.cells[0].children[0].value;
    const shares=Number(r.cells[1].children[0].value);
    if(!sym||shares<=0) return;

    let p=r.cells[2].innerText;
    let price=p.includes("USD")?Number(p)*usdToTwd:Number(p);
    const total=shares*price;

    r.cells[3].innerText=
      total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",");
    totalTWD+=total;

    stocks.push({symbol:sym,total});
  });

  rows.forEach(r=>{
    const t=Number(r.cells[3].innerText.replace(/,/g,""));
    r.cells[4].innerText=totalTWD?(t/totalTWD*100).toFixed(1):0;
  });

  document.getElementById("totalAmount").innerText=
    "總金額："+totalTWD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")+" TWD";

  renderChart(stocks);
  saveHoldings();
}

function renderChart(stocks){
  const ctx=document.getElementById("chart");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"pie",
    data:{
      labels:stocks.map(s=>s.symbol),
      datasets:[{data:stocks.map(s=>s.total)}]
    }
  });
}

window.onload=loadHoldings;
</script>
</body>
</html>
